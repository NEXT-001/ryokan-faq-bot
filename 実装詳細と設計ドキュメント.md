# マルチ企業FAQボット 実装詳細と設計ドキュメント

## アーキテクチャ概要

マルチ企業FAQボットは、モジュール化されたサービス指向のアーキテクチャで、各コンポーネントが特定の責務を持ちます。Streamlitをフロントエンドフレームワークとして、バックエンドロジックは独立したサービスモジュールで実装しています。

```
[UI層: Streamlit]  ← →  [サービス層]  ← →  [データ層: ファイルシステム]
```

## 主要コンポーネント

### 1. 設定モジュール (`config/settings.py`)

システム全体の設定を管理し、環境変数の読み込みと共通設定の提供を担当します。特に重要な機能：

- テストモード判定：APIが利用できない場合でもシステムを動作させる
- パス管理：会社IDに基づいたデータパスを提供

### 2. 企業サービス (`services/company_service.py`)

企業データの管理と認証ロジックを提供します：

- 企業データの読み込み/保存
- 企業管理者の認証
- 新規企業の登録
- 管理者アカウントの管理

### 3. エンベディングサービス (`services/embedding_service.py`)

テキストのエンベディング生成を担当します：

- APIベースのエンベディング生成（VoyageAI）
- テストモード用の擬似エンベディング生成
- 企業別FAQのエンベディング生成と保存

### 4. チャットサービス (`services/chat_service.py`)

ユーザーの質問に対する回答を提供する中核エンジン：

- 質問のエンベディング生成
- 類似度に基づく回答検索
- 適切なしきい値による回答品質の制御

### 5. 履歴サービス (`services/history_service.py`)

利用履歴の記録と表示を担当：

- 質問と回答の記録
- 会社別の履歴管理
- 管理者向け履歴表示

### 6. ログインサービス (`services/login_service.py`)

認証と権限管理を担当：

- ユーザーログイン処理
- セッション管理
- 権限チェック

### 7. FAQ管理モジュール (`admin_faq_management.py`)

FAQ管理のUI機能を提供：

- FAQ一覧表示と編集
- FAQ追加機能
- CSVインポート/エクスポート機能
- エンベディング手動再生成機能

### 8. メインアプリケーション (`main.py`)

UIフローとナビゲーションを制御：

- ページルーティング
- 顧客用チャットインターフェース
- 管理者ダッシュボード
- スーパー管理者機能

## データ構造

### 企業データ (`data/companies.json`)

企業情報と管理者アカウントを保持するJSONファイル：

```json
{
  "company-id": {
    "name": "企業名",
    "created_at": "作成日時",
    "admins": {
      "admin-username": {
        "password": "ハッシュ化パスワード",
        "email": "メールアドレス",
        "created_at": "作成日時"
      }
    }
  }
}
```

### FAQデータ (`data/companies/{company_id}/faq.csv`)

各企業のFAQを保持するCSVファイル：

```
question,answer
"質問1","回答1"
"質問2","回答2"
```

### エンベディングデータ (`data/companies/{company_id}/faq_with_embeddings.pkl`)

FAQ質問のエンベディングベクトルを含むPickleファイル（Pandas DataFrameとして保存）：

- `question`: 質問テキスト
- `answer`: 回答テキスト
- `embedding`: エンベディングベクトル（配列）

### 履歴データ (`data/companies/{company_id}/history.csv`)

ユーザーとの対話履歴を記録するCSVファイル：

```
timestamp,user_info,question,answer,input_tokens,output_tokens
"2025-05-08 12:34:56","ユーザー情報","質問","回答",10,20
```

## 主要フロー

### 1. エンベディング生成フロー

1. FAQ管理者がFAQを追加/編集/インポート
2. FAQデータがCSVとして保存
3. エンベディングサービスが各質問のエンベディングを生成
4. エンベディング付きFAQデータがPKLファイルとして保存

### 2. 質問回答フロー

1. ユーザーが企業を選択して質問を入力
2. 質問テキストがエンベディングに変換
3. コサイン類似度計算で最も類似するFAQ質問を検索
4. 類似度スコアが閾値を超える場合、対応する回答を返す
5. 質問と回答が履歴に記録される

### 3. 管理者認証フロー

1. 管理者が企業ID、ユーザー名、パスワードでログイン
2. 企業サービスが認証を検証
3. セッション状態に認証情報を保存
4. 権限に応じたUI機能を表示

## セキュリティ考慮事項

- パスワードはSHA-256でハッシュ化して保存
- パスワードは平文で保存されない
- 各企業のデータは別々のフォルダで分離管理
- アクセス権限はセッション状態で適切に管理

## 拡張性と将来の改善点

このシステムは以下の点で拡張可能に設計されています：

1. **認証システム強化**：外部認証サービスとの統合（OAuth、LDAP等）
2. **データベース統合**：ファイルシステムからSQLやNoSQLデータベースへの移行
3. **高度なエンベディング**：他のAI/MLサービスとの統合（OpenAI、Cohere等）
4. **多言語対応**：国際化と多言語FAQの管理
5. **UIカスタマイズ**：企業ごとのUI設定（テーマ、ロゴ等）
6. **分析機能**：質問傾向の分析と可視化